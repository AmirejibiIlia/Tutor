<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - Deutschly</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #2e7d5e;
            --primary-dark: #1e5c42;
            --primary-light: #e8f5ee;
            --accent: #e8a838;
            --bg: #f8f7f4;
            --card: #ffffff;
            --border: #e8e5df;
            --text: #2d2d2d;
            --text-light: #888;
            --text-muted: #aaa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .nav {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 14px 28px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav .brand {
            font-family: 'Source Serif 4', Georgia, serif;
            font-size: 1.3rem; font-weight: 700; color: var(--primary-dark);
        }
        .nav .brand span { color: var(--accent); }
        .nav-links { display: flex; align-items: center; gap: 8px; }
        .nav-link {
            padding: 7px 16px; font-size: 0.85rem; font-weight: 500;
            background: transparent; border: 1px solid var(--border);
            border-radius: 8px; cursor: pointer; color: var(--text-light);
            text-decoration: none; transition: all 0.2s;
        }
        .nav-link:hover { border-color: var(--primary); color: var(--primary); }
        .nav-link.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .nav .user-info {
            display: flex; align-items: center; gap: 14px;
            font-size: 0.88rem; color: var(--text-light);
        }
        .nav .logout-btn {
            padding: 6px 16px; font-size: 0.82rem; background: transparent;
            border: 1px solid var(--border); border-radius: 6px;
            cursor: pointer; color: var(--text-light); transition: all 0.2s;
        }
        .nav .logout-btn:hover { border-color: #ccc; color: var(--text); }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 28px 24px;
        }
        .page-title {
            font-family: 'Source Serif 4', Georgia, serif;
            font-size: 1.5rem; font-weight: 700; color: var(--primary-dark);
            margin-bottom: 24px;
        }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 28px;
        }
        .summary-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px;
            text-align: center;
        }
        .summary-card .value {
            font-family: 'Source Serif 4', Georgia, serif;
            font-size: 2.2rem; font-weight: 700; color: var(--primary-dark);
        }
        .summary-card .label {
            font-size: 0.8rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-top: 4px; font-weight: 600;
        }
        .summary-card.streak .value { color: var(--accent); }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 28px;
        }
        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
        }
        .chart-card h3 {
            font-size: 0.85rem; font-weight: 600;
            color: var(--text-light); margin-bottom: 16px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .chart-card canvas { max-height: 220px; }
        .chart-card.full { grid-column: 1 / -1; }

        /* Milestones */
        .milestones-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 28px;
        }
        .milestones-card h3 {
            font-size: 0.85rem; font-weight: 600; color: var(--text-light);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 18px;
        }
        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 12px;
        }
        .milestone {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 16px; border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .milestone.reached {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        .milestone .icon {
            font-size: 1.6rem;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px;
            background: #f0f0ec;
            flex-shrink: 0;
        }
        .milestone.reached .icon { background: var(--primary); }
        .milestone .info .name {
            font-weight: 600; font-size: 0.9rem;
            color: var(--text);
        }
        .milestone .info .target {
            font-size: 0.78rem; color: var(--text-muted);
        }
        .milestone.reached .info .target { color: var(--primary); }

        /* Difficulty breakdown */
        .diff-bar-container {
            margin-bottom: 28px;
        }
        .diff-bar {
            display: flex; height: 14px; border-radius: 7px;
            overflow: hidden; background: #eee; margin-top: 10px;
        }
        .diff-bar .segment { transition: width 0.5s; }
        .diff-bar .seg-easy { background: #81c784; }
        .diff-bar .seg-medium { background: #ffb74d; }
        .diff-bar .seg-hard { background: #e57373; }
        .diff-bar .seg-new { background: #bdbdbd; }
        .diff-legend {
            display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;
        }
        .diff-legend-item {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.82rem; color: var(--text-light);
        }
        .diff-legend-item .swatch {
            width: 10px; height: 10px; border-radius: 3px;
        }

        @media (max-width: 700px) {
            .nav { padding: 12px 16px; flex-wrap: wrap; gap: 8px; }
            .nav .brand { font-size: 1.1rem; }
            .nav-links { order: 3; width: 100%; justify-content: center; }
            .nav-link { padding: 6px 12px; font-size: 0.8rem; }
            .nav .user-info { gap: 8px; font-size: 0.82rem; }
            .nav .logout-btn { padding: 5px 12px; font-size: 0.78rem; }
            .container { padding: 16px 12px; }
            .page-title { font-size: 1.25rem; }
            .charts-grid { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .summary-card { padding: 16px; }
            .summary-card .value { font-size: 1.8rem; }
            .chart-card { padding: 18px; }
            .milestones-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="nav">
        <div class="brand">Deutsch<span>ly</span></div>
        <div class="nav-links">
            <a href="/" class="nav-link">Dictionary</a>
            <a href="/practice" class="nav-link">Practice</a>
            <a href="/stats" class="nav-link active">Statistics</a>
        </div>
        <div class="user-info">
            <span id="usernameDisplay"></span>
            <button class="logout-btn" onclick="doLogout()">Log out</button>
        </div>
    </div>

    <div class="container">
        <h1 class="page-title">Your Progress</h1>

        <div class="summary-grid" id="summaryGrid"></div>

        <div class="diff-bar-container" id="diffSection"></div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Words by Type</h3>
                <canvas id="typeChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Known vs Learning</h3>
                <canvas id="knownChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>CEFR Level Distribution</h3>
                <canvas id="levelChart"></canvas>
            </div>
            <div class="chart-card full">
                <h3>Words Added (Last 30 Days)</h3>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <div class="milestones-card">
            <h3>Milestones</h3>
            <div class="milestones-grid" id="milestonesGrid"></div>
        </div>
    </div>

    <script>
        const ICONS = {
            seed: '&#127793;', sprout: '&#127±;', leaf: '&#127807;',
            tree: '&#127795;', star: '&#11088;', fire: '&#128293;',
            book: '&#128214;', crown: '&#128081;'
        };
        // Fix sprout
        ICONS.sprout = '&#127793;';

        fetch('/api/me').then(r => r.json()).then(data => {
            if (data.logged_in) document.getElementById('usernameDisplay').textContent = data.username;
            else window.location.href = '/login';
        });

        async function doLogout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        const TYPE_COLORS = {
            noun: '#3b5998', verb: '#27713a', adjective: '#b5651d',
            adverb: '#6b3fa0', preposition: '#c0392b', conjunction: '#1a8a8a',
            pronoun: '#8b6914', particle: '#777', other: '#999'
        };

        fetch('/api/stats').then(r => r.json()).then(renderStats);

        function renderStats(s) {
            const known = s.known_stats.known || 0;
            const learning = s.known_stats.learning || 0;

            document.getElementById('summaryGrid').innerHTML = `
                <div class="summary-card">
                    <div class="value">${s.total}</div>
                    <div class="label">Total Words</div>
                </div>
                <div class="summary-card streak">
                    <div class="value">${s.streak}</div>
                    <div class="label">Day Streak</div>
                </div>
                <div class="summary-card">
                    <div class="value">${known}</div>
                    <div class="label">Words I Know</div>
                </div>
                <div class="summary-card">
                    <div class="value">${learning}</div>
                    <div class="label">Still Learning</div>
                </div>
            `;

            // Known bar
            const total = s.total || 1;
            document.getElementById('diffSection').innerHTML = `
                <div class="diff-bar">
                    <div class="segment seg-easy" style="width:${known/total*100}%"></div>
                    <div class="segment seg-new" style="width:${learning/total*100}%"></div>
                </div>
                <div class="diff-legend">
                    <div class="diff-legend-item"><div class="swatch" style="background:#81c784"></div>Known (${known})</div>
                    <div class="diff-legend-item"><div class="swatch" style="background:#bdbdbd"></div>Still learning (${learning})</div>
                </div>
            `;

            // Type doughnut
            const typeLabels = s.by_type.map(t => t.word_type || 'other');
            const typeData = s.by_type.map(t => t.count);
            const typeColors = typeLabels.map(t => TYPE_COLORS[t.toLowerCase()] || '#999');

            new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: typeLabels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{ data: typeData, backgroundColor: typeColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 14, font: { size: 12 } } }
                    }
                }
            });

            // Known doughnut
            new Chart(document.getElementById('knownChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Known', 'Still learning'],
                    datasets: [{
                        data: [known, learning],
                        backgroundColor: ['#81c784', '#bdbdbd'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 14, font: { size: 12 } } }
                    }
                }
            });

            // Level bar chart
            const LEVEL_COLORS = { A1: '#2e7d32', A2: '#558b2f', B1: '#f9a825', B2: '#e65100', C1: '#c62828', C2: '#6a1b9a', unknown: '#bdbdbd' };
            const levelLabels = s.by_level.map(l => l.level);
            const levelData = s.by_level.map(l => l.count);
            const levelColors = levelLabels.map(l => LEVEL_COLORS[l] || '#999');

            new Chart(document.getElementById('levelChart'), {
                type: 'bar',
                data: {
                    labels: levelLabels,
                    datasets: [{ data: levelData, backgroundColor: levelColors, borderRadius: 4 }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });

            // Daily bar chart
            const dailyLabels = s.daily.map(d => {
                const dt = new Date(d.day);
                return dt.toLocaleDateString('en', { month: 'short', day: 'numeric' });
            });
            const dailyData = s.daily.map(d => d.count);

            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Words added',
                        data: dailyData,
                        backgroundColor: 'rgba(46, 125, 94, 0.7)',
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Milestones
            const milestoneIcons = ['&#127793;', '&#127�;', '&#127807;', '&#127795;', '&#11088;', '&#128293;', '&#128214;', '&#128081;'];
            document.getElementById('milestonesGrid').innerHTML = s.milestones.map((m, i) => `
                <div class="milestone ${m.reached ? 'reached' : ''}">
                    <div class="icon">${milestoneIcons[i] || '&#11088;'}</div>
                    <div class="info">
                        <div class="name">${m.label}</div>
                        <div class="target">${m.reached ? 'Reached!' : `${s.total}/${m.target} words`}</div>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
